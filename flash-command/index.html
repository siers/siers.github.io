<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flash Command</title>
<style>
  :root { --bg: hsl(28 30% 13%); --fg: #efeae6; }

  html,body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  .wrap { height: 100dvh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .number { font-weight: 700; font-size: 60vmin; display: inline-block; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); transition: transform 450ms ease; }
  .wrap[data-mode=violin] .number { font-family: monospace; font-size: 60px; }
  ::selection { background: transparent; }
</style>
</head>
<body>
  <div class="wrap">
    <div id="number" class="number">0</div>
  </div>

  <script>
    function randomViolinNote(string, pos, semi) {
      var [s_, f_, n_] = ['♯', '♭', '♮']

      var strings = [
        {name: 'G', number: 0},
        {name: 'D', number: 1},
        {name: 'A', number: 2},
        {name: 'E', number: 3},
      ]

      var positions = [
        {name: '1', count: 1, semi: 2},
        {name: '2', count: 2, semi: 4},
        {name: '3', count: 3, semi: 5},
        {name: '4', count: 4, semi: 7},
        {name: '5', count: 5, semi: 9},
      ]

      // TODO: make -1 a valid position semitone
      var positionSemitones = [-1, 0, 1, 2, 3, 4, 5, 6]

      function log(x) {
        // console.log(x)
      }

      function randInt(from, to) {
        return from + Math.floor(Math.random() * (to - from + 1))
      }

      function pick(array) {
        return array[randInt(0, array.length - 1)]
      }

      // input: piano key number
      function nameNote(semi) {
        var und = undefined
        var notes = [
          {f: und, n: 'A', s: und},
          {f: 'B', n: und, s: 'A'},
          {f: 'C', n: 'B', s: und},
          {f: und, n: 'C', s: 'B'},
          {f: 'D', n: und, s: 'C'},
          {f: und, n: 'D', s: und},
          {f: 'E', n: und, s: 'D'},
          {f: und, n: 'E', s: und},
          {f: und, n: 'F', s: und},
          {f: 'G', n: und, s: 'F'},
          {f: und, n: 'G', s: und},
          {f: 'A', n: und, s: 'G'},
        ].map(n => {
          return {f: n.f && n.f + f_, n: n.n && n.n + n_, s: n.s && n.s + s_}
        })
        return notes[(24 + semi) % 12]
      }

      // TODO FIX: the random is slightly biased, because it's rand(position) + rand(semitone)
      function main(string, pos, semi) {
        string = string !== undefined ? string : pick(strings)
        pos = pos !== undefined ? pos : pick(positions)
        semi = semi !== undefined ? semi : pick(positionSemitones)
        var name = pick(Object.values(nameNote(string.number * 7 + pos.semi + semi - 2)).filter(n => n))

        log(string.number * 7, pos.semi, semi - 2)

        var fingers = {
          a: 1
        }[semi]
        var finger = 1

        var rightPad = (s, n) => ('' + s).padEnd(n, ' ').replaceAll(' ', '&nbsp;')
        var fingerLabel = ('' + (finger / 2))
          .replace(/^(\d)$/, "$1.")
          .replace('.5', '½')
          .replace('0½', '.½')

        return `${string.name}/${pos.name}p/${rightPad(name, 2)}/${fingerLabel}`
      }

      // console.log(main(strings[3], positions[3]))

      return main(
        string !== undefined ? strings[string] : undefined,
        pos !== undefined ? positions[pos] : undefined,
        semi,
      )
    }
  </script>

  <script>
    function randomItem(array) {
      return array[Math.floor(Math.random() * array.length)]
    }

    const number = document.getElementById('number')

    function getHash() {
      return location.hash.substr(1)
    }

    function getInterval() {
      var parts = getHash().indexOf(':') == -1 ? [] : getHash().split(':')
      return parts[0] || 3000
    }

    function getThings() {
      return (getHash() != '') ? getHash().split(':').at(-1).split('-') : [0, 1, 2, 3]
    }

    function getMode() {
      if (JSON.stringify(getThings()) == '["violin"]')
        return 'violin'
      else
        return 'regular'
    }

    function nextItem() {
      document.querySelector('.wrap').dataset.mode = getMode()

      if (getMode() == 'violin')
        number.innerHTML = randomViolinNote()
      else
        number.innerHTML = randomItem(getThings())

      setTimeout(nextItem, getInterval())
    }

    setTimeout(nextItem, getInterval())

    addEventListener("hashchange", () => document.location.reload())
    addEventListener("DOMContentLoaded", nextItem)
  </script>
</body>
</html>
