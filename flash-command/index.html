<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flash Command</title>
<style>
  :root { --bg: hsl(28 30% 13%); --fg: #efeae6; }

  html,body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  .stop { position: absolute; top: 1em; left: 1em; font-size: 3em; }
  .wrap { height: 100dvh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .number { font-weight: 700; font-size: 60vmin; display: inline-block; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); transition: transform 450ms ease; text-wrap: nowrap; }
  .wrap[data-mode=violin] .number { font-family: monospace; font-size: 60px; }
  ::selection { background: transparent; }
</style>
</head>
<body>
  <a class="stop" onclick="stop">stop</a>

  <div class="wrap">
    <div id="number" class="number">0</div>
  </div>

  <script>
    function randInt(from, to) {
      return from + Math.floor(Math.random() * (to - from + 1))
    }

    function pick(array) {
      return array[randInt(0, array.length - 1)]
    }

    // input: number, number, number, string, string
    // output: [[keyNr, string]]
    function randomViolinNote(string, pos, semi, slide, bowing) {
      var [s_, f_, n_] = ['♯', '♭', '♮']

      var strings = [
        {name: 'G', number: 0},
        {name: 'D', number: 1},
        {name: 'A', number: 2},
        {name: 'E', number: 3},
      ]

      var positions = [
        {name: '.5', count: 0, semi: 1},
        {name: '1.', count: 1, semi: 2},
        {name: '2a', count: 2, semi: 3},
        {name: '2b', count: 3, semi: 4},
        {name: '3a', count: 4, semi: 5},
        {name: '3b', count: 5, semi: 6},
        {name: '4a', count: 6, semi: 7},
        {name: '4b', count: 7, semi: 8},
        {name: '5a', count: 8, semi: 9},
        {name: '5b', count: 8, semi: 10},
      ]

      var positionSemitones = [-1, 0, 1, 2, 3, 4, 5, 6]

      // input: piano key number
      function nameNote(semi) {
        var und = undefined
        var notes = [
          {s: und, n: 'A', f: und},
          {s: 'A', n: und, f: 'B'},
          {s: und, n: 'B', f: 'C'},
          {s: 'B', n: 'C', f: und},
          {s: 'C', n: und, f: 'D'},
          {s: und, n: 'D', f: und},
          {s: 'D', n: und, f: 'E'},
          {s: und, n: 'E', f: und},
          {s: und, n: 'F', f: und},
          {s: 'F', n: und, f: 'G'},
          {s: und, n: 'G', f: und},
          {s: 'G', n: und, f: 'A'},
        ].map(n => {
          return {f: n.f && n.f + f_, n: n.n && n.n + n_, s: n.s && n.s + s_}
        })
        return notes[(12000 + semi - 49) % 12]
      }

      function main(string, pos, semi, slide, bowing) {
        string = string === undefined ? pick(strings) : string
        pos    = pos === undefined ? pick(positions) : pos
        semi   = semi === undefined ? pick(pos.count > 0 ? positionSemitones : positionSemitones.slice(1)) : semi

        var semiOffset = string.number * 7 + pos.semi + semi
        var totalSemitone = 47 + semiOffset

        var slide  = slide === undefined ? pick('-↑↓'.split('')) : slide
        var bowing = bowing === undefined ? pick('VΠ'.split('')) : bowing

        var fingerMap = {
          '-1': ['.½'],
          '0': ['1.'],
          '1': ['1+', '2-'],
          '2': ['2+'],
          '3': ['3-'],
          '4': ['3+'],
          '5': ['4-'],
          '6': ['4+'],
        }

        return Object.values(nameNote(totalSemitone)).filter(n => n).map(noteName => {
          return fingerMap[semi].flatMap(finger => {
            var rightPad = (s, n) => ('' + s).padEnd(n, ' ').replaceAll(' ', '&nbsp;')
            var label = `${string.name}/${pos.name}/${finger}=${rightPad(noteName, 2)} ${slide}/${bowing}`

            return [totalSemitone, label]
          })
        })
      }

      return main(
        string !== undefined ? strings[string] : undefined,
        pos !== undefined ? positions[pos] : undefined,
        semi,
        slide,
        bowing,
      )
    }

    var test = {
      expect: [
        [[0,0,0],[[48,"G/.5/A♭/1. -/Π"],[48,"G/.5/G♯/1. -/Π"]]],
        [[0,0,1],[[49,"G/.5/A♮/1+ -/Π",49,"G/.5/A♮/2- -/Π"]]],
        [[0,0,2],[[50,"G/.5/B♭/2+ -/Π"],[50,"G/.5/A♯/2+ -/Π"]]],
        [[0,0,3],[[51,"G/.5/C♭/3- -/Π"],[51,"G/.5/B♮/3- -/Π"]]],
        [[0,1,0],[[49,"G/1./A♮/1. -/Π"]]],
        [[0,1,1],[[50,"G/1./B♭/1+ -/Π",50,"G/1./B♭/2- -/Π"],[50,"G/1./A♯/1+ -/Π",50,"G/1./A♯/2- -/Π"]]],
        [[0,1,2],[[51,"G/1./C♭/2+ -/Π"],[51,"G/1./B♮/2+ -/Π"]]],
        [[0,1,3],[[52,"G/1./C♮/3- -/Π"],[52,"G/1./B♯/3- -/Π"]]],
        [[0,2,0],[[50,"G/2a/B♭/1. -/Π"],[50,"G/2a/A♯/1. -/Π"]]],
        [[0,2,1],[[51,"G/2a/C♭/1+ -/Π",51,"G/2a/C♭/2- -/Π"],[51,"G/2a/B♮/1+ -/Π",51,"G/2a/B♮/2- -/Π"]]],
        [[0,2,2],[[52,"G/2a/C♮/2+ -/Π"],[52,"G/2a/B♯/2+ -/Π"]]],
        [[0,2,3],[[53,"G/2a/D♭/3- -/Π"],[53,"G/2a/C♯/3- -/Π"]]],
        [[0,3,0],[[51,"G/2b/C♭/1. -/Π"],[51,"G/2b/B♮/1. -/Π"]]],
        [[0,3,1],[[52,"G/2b/C♮/1+ -/Π",52,"G/2b/C♮/2- -/Π"],[52,"G/2b/B♯/1+ -/Π",52,"G/2b/B♯/2- -/Π"]]],
        [[0,3,2],[[53,"G/2b/D♭/2+ -/Π"],[53,"G/2b/C♯/2+ -/Π"]]],
        [[0,3,3],[[54,"G/2b/D♮/3- -/Π"]]],
        [[0,4,0],[[52,"G/3a/C♮/1. -/Π"],[52,"G/3a/B♯/1. -/Π"]]],
        [[0,4,1],[[53,"G/3a/D♭/1+ -/Π",53,"G/3a/D♭/2- -/Π"],[53,"G/3a/C♯/1+ -/Π",53,"G/3a/C♯/2- -/Π"]]],
        [[0,4,2],[[54,"G/3a/D♮/2+ -/Π"]]],
        [[0,4,3],[[55,"G/3a/E♭/3- -/Π"],[55,"G/3a/D♯/3- -/Π"]]],
        [[0,5,0],[[53,"G/3b/D♭/1. -/Π"],[53,"G/3b/C♯/1. -/Π"]]],
        [[0,5,1],[[54,"G/3b/D♮/1+ -/Π",54,"G/3b/D♮/2- -/Π"]]],
        [[0,5,2],[[55,"G/3b/E♭/2+ -/Π"],[55,"G/3b/D♯/2+ -/Π"]]],
        [[0,5,3],[[56,"G/3b/E♮/3- -/Π"]]],
        [[0,6,0],[[54,"G/4a/D♮/1. -/Π"]]],
        [[0,6,1],[[55,"G/4a/E♭/1+ -/Π",55,"G/4a/E♭/2- -/Π"],[55,"G/4a/D♯/1+ -/Π",55,"G/4a/D♯/2- -/Π"]]],
        [[0,6,2],[[56,"G/4a/E♮/2+ -/Π"]]],
        [[0,6,3],[[57,"G/4a/F♮/3- -/Π"]]],
        [[0,7,0],[[55,"G/4b/E♭/1. -/Π"],[55,"G/4b/D♯/1. -/Π"]]],
        [[0,7,1],[[56,"G/4b/E♮/1+ -/Π",56,"G/4b/E♮/2- -/Π"]]],
        [[0,7,2],[[57,"G/4b/F♮/2+ -/Π"]]],
        [[0,7,3],[[58,"G/4b/G♭/3- -/Π"],[58,"G/4b/F♯/3- -/Π"]]],
        [[0,8,0],[[56,"G/5a/E♮/1. -/Π"]]],
        [[0,8,1],[[57,"G/5a/F♮/1+ -/Π",57,"G/5a/F♮/2- -/Π"]]],
        [[0,8,2],[[58,"G/5a/G♭/2+ -/Π"],[58,"G/5a/F♯/2+ -/Π"]]],
        [[0,8,3],[[59,"G/5a/G♮/3- -/Π"]]],
        [[0,9,0],[[57,"G/5b/F♮/1. -/Π"]]],
        [[0,9,1],[[58,"G/5b/G♭/1+ -/Π",58,"G/5b/G♭/2- -/Π"],[58,"G/5b/F♯/1+ -/Π",58,"G/5b/F♯/2- -/Π"]]],
        [[0,9,2],[[59,"G/5b/G♮/2+ -/Π"]]],
        [[0,9,3],[[60,"G/5b/A♭/3- -/Π"],[60,"G/5b/G♯/3- -/Π"]]],
        [[1,0,0],[[55,"D/.5/E♭/1. -/Π"],[55,"D/.5/D♯/1. -/Π"]]],
        [[1,0,1],[[56,"D/.5/E♮/1+ -/Π",56,"D/.5/E♮/2- -/Π"]]],
        [[1,0,2],[[57,"D/.5/F♮/2+ -/Π"]]],
        [[1,0,3],[[58,"D/.5/G♭/3- -/Π"],[58,"D/.5/F♯/3- -/Π"]]],
        [[1,1,0],[[56,"D/1./E♮/1. -/Π"]]],
        [[1,1,1],[[57,"D/1./F♮/1+ -/Π",57,"D/1./F♮/2- -/Π"]]],
        [[1,1,2],[[58,"D/1./G♭/2+ -/Π"],[58,"D/1./F♯/2+ -/Π"]]],
        [[1,1,3],[[59,"D/1./G♮/3- -/Π"]]],
        [[1,2,0],[[57,"D/2a/F♮/1. -/Π"]]],
        [[1,2,1],[[58,"D/2a/G♭/1+ -/Π",58,"D/2a/G♭/2- -/Π"],[58,"D/2a/F♯/1+ -/Π",58,"D/2a/F♯/2- -/Π"]]],
        [[1,2,2],[[59,"D/2a/G♮/2+ -/Π"]]],
        [[1,2,3],[[60,"D/2a/A♭/3- -/Π"],[60,"D/2a/G♯/3- -/Π"]]],
        [[1,3,0],[[58,"D/2b/G♭/1. -/Π"],[58,"D/2b/F♯/1. -/Π"]]],
        [[1,3,1],[[59,"D/2b/G♮/1+ -/Π",59,"D/2b/G♮/2- -/Π"]]],
        [[1,3,2],[[60,"D/2b/A♭/2+ -/Π"],[60,"D/2b/G♯/2+ -/Π"]]],
        [[1,3,3],[[61,"D/2b/A♮/3- -/Π"]]],
        [[1,4,0],[[59,"D/3a/G♮/1. -/Π"]]],
        [[1,4,1],[[60,"D/3a/A♭/1+ -/Π",60,"D/3a/A♭/2- -/Π"],[60,"D/3a/G♯/1+ -/Π",60,"D/3a/G♯/2- -/Π"]]],
        [[1,4,2],[[61,"D/3a/A♮/2+ -/Π"]]],
        [[1,4,3],[[62,"D/3a/B♭/3- -/Π"],[62,"D/3a/A♯/3- -/Π"]]],
        [[1,5,0],[[60,"D/3b/A♭/1. -/Π"],[60,"D/3b/G♯/1. -/Π"]]],
        [[1,5,1],[[61,"D/3b/A♮/1+ -/Π",61,"D/3b/A♮/2- -/Π"]]],
        [[1,5,2],[[62,"D/3b/B♭/2+ -/Π"],[62,"D/3b/A♯/2+ -/Π"]]],
        [[1,5,3],[[63,"D/3b/C♭/3- -/Π"],[63,"D/3b/B♮/3- -/Π"]]],
        [[1,6,0],[[61,"D/4a/A♮/1. -/Π"]]],
        [[1,6,1],[[62,"D/4a/B♭/1+ -/Π",62,"D/4a/B♭/2- -/Π"],[62,"D/4a/A♯/1+ -/Π",62,"D/4a/A♯/2- -/Π"]]],
        [[1,6,2],[[63,"D/4a/C♭/2+ -/Π"],[63,"D/4a/B♮/2+ -/Π"]]],
        [[1,6,3],[[64,"D/4a/C♮/3- -/Π"],[64,"D/4a/B♯/3- -/Π"]]],
        [[1,7,0],[[62,"D/4b/B♭/1. -/Π"],[62,"D/4b/A♯/1. -/Π"]]],
        [[1,7,1],[[63,"D/4b/C♭/1+ -/Π",63,"D/4b/C♭/2- -/Π"],[63,"D/4b/B♮/1+ -/Π",63,"D/4b/B♮/2- -/Π"]]],
        [[1,7,2],[[64,"D/4b/C♮/2+ -/Π"],[64,"D/4b/B♯/2+ -/Π"]]],
        [[1,7,3],[[65,"D/4b/D♭/3- -/Π"],[65,"D/4b/C♯/3- -/Π"]]],
        [[1,8,0],[[63,"D/5a/C♭/1. -/Π"],[63,"D/5a/B♮/1. -/Π"]]],
        [[1,8,1],[[64,"D/5a/C♮/1+ -/Π",64,"D/5a/C♮/2- -/Π"],[64,"D/5a/B♯/1+ -/Π",64,"D/5a/B♯/2- -/Π"]]],
        [[1,8,2],[[65,"D/5a/D♭/2+ -/Π"],[65,"D/5a/C♯/2+ -/Π"]]],
        [[1,8,3],[[66,"D/5a/D♮/3- -/Π"]]],
        [[1,9,0],[[64,"D/5b/C♮/1. -/Π"],[64,"D/5b/B♯/1. -/Π"]]],
        [[1,9,1],[[65,"D/5b/D♭/1+ -/Π",65,"D/5b/D♭/2- -/Π"],[65,"D/5b/C♯/1+ -/Π",65,"D/5b/C♯/2- -/Π"]]],
        [[1,9,2],[[66,"D/5b/D♮/2+ -/Π"]]],
        [[1,9,3],[[67,"D/5b/E♭/3- -/Π"],[67,"D/5b/D♯/3- -/Π"]]],
        [[2,0,0],[[62,"A/.5/B♭/1. -/Π"],[62,"A/.5/A♯/1. -/Π"]]],
        [[2,0,1],[[63,"A/.5/C♭/1+ -/Π",63,"A/.5/C♭/2- -/Π"],[63,"A/.5/B♮/1+ -/Π",63,"A/.5/B♮/2- -/Π"]]],
        [[2,0,2],[[64,"A/.5/C♮/2+ -/Π"],[64,"A/.5/B♯/2+ -/Π"]]],
        [[2,0,3],[[65,"A/.5/D♭/3- -/Π"],[65,"A/.5/C♯/3- -/Π"]]],
        [[2,1,0],[[63,"A/1./C♭/1. -/Π"],[63,"A/1./B♮/1. -/Π"]]],
        [[2,1,1],[[64,"A/1./C♮/1+ -/Π",64,"A/1./C♮/2- -/Π"],[64,"A/1./B♯/1+ -/Π",64,"A/1./B♯/2- -/Π"]]],
        [[2,1,2],[[65,"A/1./D♭/2+ -/Π"],[65,"A/1./C♯/2+ -/Π"]]],
        [[2,1,3],[[66,"A/1./D♮/3- -/Π"]]],
        [[2,2,0],[[64,"A/2a/C♮/1. -/Π"],[64,"A/2a/B♯/1. -/Π"]]],
        [[2,2,1],[[65,"A/2a/D♭/1+ -/Π",65,"A/2a/D♭/2- -/Π"],[65,"A/2a/C♯/1+ -/Π",65,"A/2a/C♯/2- -/Π"]]],
        [[2,2,2],[[66,"A/2a/D♮/2+ -/Π"]]],
        [[2,2,3],[[67,"A/2a/E♭/3- -/Π"],[67,"A/2a/D♯/3- -/Π"]]],
        [[2,3,0],[[65,"A/2b/D♭/1. -/Π"],[65,"A/2b/C♯/1. -/Π"]]],
        [[2,3,1],[[66,"A/2b/D♮/1+ -/Π",66,"A/2b/D♮/2- -/Π"]]],
        [[2,3,2],[[67,"A/2b/E♭/2+ -/Π"],[67,"A/2b/D♯/2+ -/Π"]]],
        [[2,3,3],[[68,"A/2b/E♮/3- -/Π"]]],
        [[2,4,0],[[66,"A/3a/D♮/1. -/Π"]]],
        [[2,4,1],[[67,"A/3a/E♭/1+ -/Π",67,"A/3a/E♭/2- -/Π"],[67,"A/3a/D♯/1+ -/Π",67,"A/3a/D♯/2- -/Π"]]],
        [[2,4,2],[[68,"A/3a/E♮/2+ -/Π"]]],
        [[2,4,3],[[69,"A/3a/F♮/3- -/Π"]]],
        [[2,5,0],[[67,"A/3b/E♭/1. -/Π"],[67,"A/3b/D♯/1. -/Π"]]],
        [[2,5,1],[[68,"A/3b/E♮/1+ -/Π",68,"A/3b/E♮/2- -/Π"]]],
        [[2,5,2],[[69,"A/3b/F♮/2+ -/Π"]]],
        [[2,5,3],[[70,"A/3b/G♭/3- -/Π"],[70,"A/3b/F♯/3- -/Π"]]],
        [[2,6,0],[[68,"A/4a/E♮/1. -/Π"]]],
        [[2,6,1],[[69,"A/4a/F♮/1+ -/Π",69,"A/4a/F♮/2- -/Π"]]],
        [[2,6,2],[[70,"A/4a/G♭/2+ -/Π"],[70,"A/4a/F♯/2+ -/Π"]]],
        [[2,6,3],[[71,"A/4a/G♮/3- -/Π"]]],
        [[2,7,0],[[69,"A/4b/F♮/1. -/Π"]]],
        [[2,7,1],[[70,"A/4b/G♭/1+ -/Π",70,"A/4b/G♭/2- -/Π"],[70,"A/4b/F♯/1+ -/Π",70,"A/4b/F♯/2- -/Π"]]],
        [[2,7,2],[[71,"A/4b/G♮/2+ -/Π"]]],
        [[2,7,3],[[72,"A/4b/A♭/3- -/Π"],[72,"A/4b/G♯/3- -/Π"]]],
        [[2,8,0],[[70,"A/5a/G♭/1. -/Π"],[70,"A/5a/F♯/1. -/Π"]]],
        [[2,8,1],[[71,"A/5a/G♮/1+ -/Π",71,"A/5a/G♮/2- -/Π"]]],
        [[2,8,2],[[72,"A/5a/A♭/2+ -/Π"],[72,"A/5a/G♯/2+ -/Π"]]],
        [[2,8,3],[[73,"A/5a/A♮/3- -/Π"]]],
        [[2,9,0],[[71,"A/5b/G♮/1. -/Π"]]],
        [[2,9,1],[[72,"A/5b/A♭/1+ -/Π",72,"A/5b/A♭/2- -/Π"],[72,"A/5b/G♯/1+ -/Π",72,"A/5b/G♯/2- -/Π"]]],
        [[2,9,2],[[73,"A/5b/A♮/2+ -/Π"]]],
        [[2,9,3],[[74,"A/5b/B♭/3- -/Π"],[74,"A/5b/A♯/3- -/Π"]]],
        [[3,0,0],[[69,"E/.5/F♮/1. -/Π"]]],
        [[3,0,1],[[70,"E/.5/G♭/1+ -/Π",70,"E/.5/G♭/2- -/Π"],[70,"E/.5/F♯/1+ -/Π",70,"E/.5/F♯/2- -/Π"]]],
        [[3,0,2],[[71,"E/.5/G♮/2+ -/Π"]]],
        [[3,0,3],[[72,"E/.5/A♭/3- -/Π"],[72,"E/.5/G♯/3- -/Π"]]],
        [[3,1,0],[[70,"E/1./G♭/1. -/Π"],[70,"E/1./F♯/1. -/Π"]]],
        [[3,1,1],[[71,"E/1./G♮/1+ -/Π",71,"E/1./G♮/2- -/Π"]]],
        [[3,1,2],[[72,"E/1./A♭/2+ -/Π"],[72,"E/1./G♯/2+ -/Π"]]],
        [[3,1,3],[[73,"E/1./A♮/3- -/Π"]]],
        [[3,2,0],[[71,"E/2a/G♮/1. -/Π"]]],
        [[3,2,1],[[72,"E/2a/A♭/1+ -/Π",72,"E/2a/A♭/2- -/Π"],[72,"E/2a/G♯/1+ -/Π",72,"E/2a/G♯/2- -/Π"]]],
        [[3,2,2],[[73,"E/2a/A♮/2+ -/Π"]]],
        [[3,2,3],[[74,"E/2a/B♭/3- -/Π"],[74,"E/2a/A♯/3- -/Π"]]],
        [[3,3,0],[[72,"E/2b/A♭/1. -/Π"],[72,"E/2b/G♯/1. -/Π"]]],
        [[3,3,1],[[73,"E/2b/A♮/1+ -/Π",73,"E/2b/A♮/2- -/Π"]]],
        [[3,3,2],[[74,"E/2b/B♭/2+ -/Π"],[74,"E/2b/A♯/2+ -/Π"]]],
        [[3,3,3],[[75,"E/2b/C♭/3- -/Π"],[75,"E/2b/B♮/3- -/Π"]]],
        [[3,4,0],[[73,"E/3a/A♮/1. -/Π"]]],
        [[3,4,1],[[74,"E/3a/B♭/1+ -/Π",74,"E/3a/B♭/2- -/Π"],[74,"E/3a/A♯/1+ -/Π",74,"E/3a/A♯/2- -/Π"]]],
        [[3,4,2],[[75,"E/3a/C♭/2+ -/Π"],[75,"E/3a/B♮/2+ -/Π"]]],
        [[3,4,3],[[76,"E/3a/C♮/3- -/Π"],[76,"E/3a/B♯/3- -/Π"]]],
        [[3,5,0],[[74,"E/3b/B♭/1. -/Π"],[74,"E/3b/A♯/1. -/Π"]]],
        [[3,5,1],[[75,"E/3b/C♭/1+ -/Π",75,"E/3b/C♭/2- -/Π"],[75,"E/3b/B♮/1+ -/Π",75,"E/3b/B♮/2- -/Π"]]],
        [[3,5,2],[[76,"E/3b/C♮/2+ -/Π"],[76,"E/3b/B♯/2+ -/Π"]]],
        [[3,5,3],[[77,"E/3b/D♭/3- -/Π"],[77,"E/3b/C♯/3- -/Π"]]],
        [[3,6,0],[[75,"E/4a/C♭/1. -/Π"],[75,"E/4a/B♮/1. -/Π"]]],
        [[3,6,1],[[76,"E/4a/C♮/1+ -/Π",76,"E/4a/C♮/2- -/Π"],[76,"E/4a/B♯/1+ -/Π",76,"E/4a/B♯/2- -/Π"]]],
        [[3,6,2],[[77,"E/4a/D♭/2+ -/Π"],[77,"E/4a/C♯/2+ -/Π"]]],
        [[3,6,3],[[78,"E/4a/D♮/3- -/Π"]]],
        [[3,7,0],[[76,"E/4b/C♮/1. -/Π"],[76,"E/4b/B♯/1. -/Π"]]],
        [[3,7,1],[[77,"E/4b/D♭/1+ -/Π",77,"E/4b/D♭/2- -/Π"],[77,"E/4b/C♯/1+ -/Π",77,"E/4b/C♯/2- -/Π"]]],
        [[3,7,2],[[78,"E/4b/D♮/2+ -/Π"]]],
        [[3,7,3],[[79,"E/4b/E♭/3- -/Π"],[79,"E/4b/D♯/3- -/Π"]]],
        [[3,8,0],[[77,"E/5a/D♭/1. -/Π"],[77,"E/5a/C♯/1. -/Π"]]],
        [[3,8,1],[[78,"E/5a/D♮/1+ -/Π",78,"E/5a/D♮/2- -/Π"]]],
        [[3,8,2],[[79,"E/5a/E♭/2+ -/Π"],[79,"E/5a/D♯/2+ -/Π"]]],
        [[3,8,3],[[80,"E/5a/E♮/3- -/Π"]]],
        [[3,9,0],[[78,"E/5b/D♮/1. -/Π"]]],
        [[3,9,1],[[79,"E/5b/E♭/1+ -/Π",79,"E/5b/E♭/2- -/Π"],[79,"E/5b/D♯/1+ -/Π",79,"E/5b/D♯/2- -/Π"]]],
        [[3,9,2],[[80,"E/5b/E♮/2+ -/Π"]]],
        [[3,9,3],[[81,"E/5b/F♮/3- -/Π"]]]
      ],
      actual: null,
      printActual: function() {
        console.log(JSON.stringify(test.actual))
        // use :s/]],\[/]],\r[/g to straighten out
      },
    }

    function randomViolinNoteTests() {
      test.actual = [];

      [0, 1, 2, 3].forEach(string => {
        [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].forEach(pos => {
          [0, 1, 2, 3].forEach(semi => {
            var should = test.expect.filter(a => JSON.stringify(a[0]) == JSON.stringify([string, pos, semi]))
            var is = randomViolinNote(string, pos, semi, '-', 'Π')
            test.actual.push([[string, pos, semi], is])

            if (JSON.stringify(should[0][1]) != JSON.stringify(is))
              console.log(`${JSON.stringify(should)} != ${JSON.stringify([[string, pos, semi], is])}`)
          })
        })
      })
    }

    randomViolinNoteTests()
  </script>

<script>
    function shiftBy(arr, n) {
      const len = arr.length;
      if (len === 0) return [];
      n = ((n % len) + len) % len; // normalize
      return arr.slice(-n).concat(arr.slice(0, len - n));
    }

    function droneFrequencyDecibels() {
      return [
        [110.357666,-31.528101],
        [220.042419,-28.646994],
        [440.084839,-24.412590],
        [660.473083,-38.638454],
        [880.169678,-28.603935],
        [1320.254517,-29.170403],
      ]
    }

    function baseFrequencyCoefs(baseFreq) {
      var coefs = droneFrequencyDecibels()
      var highestHz = Math.floor(Math.max(...coefs.map(x => x[0])))
      var real = new Float32Array(Array(highestHz).fill(0))
      var imag = new Float32Array(Array(highestHz).fill(0))

      coefs.forEach(a => real[Math.floor(Math.floor(a[0]) * (baseFreq / 440))] = Math.pow(10, a[1] / 20))

      return [new Float32Array(real), new Float32Array(imag)]
    }

    function createOscillatorBeefy(fundamental) {
      let osc = audioCtx.createOscillator()
      const wave = audioCtx.createPeriodicWave(...baseFrequencyCoefs(fundamental))

      osc.setPeriodicWave(wave)
      osc.frequency.value = 1

      return osc
    }

    function fromPianoToFreq(keyNr) {
      return 2 ** ((keyNr - 49) / 12) * 442
    }

    function playTone(tone) {
      if (osc) osc.stop(audioCtx.currentTime)

      osc = createOscillatorBeefy(tone)
      osc.connect(audioCtx.destination)
      osc.start()
    }

    function stop(event) {
      if (event) event.stopPropagation()
      if (osc) osc.stop()
      clearTimeout(timeoutId)
    }

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)()
    let tones = [] // see getTones()
    let osc
  </script>

  <script>
    function randomItem(array) {
      return array[Math.floor(Math.random() * array.length)]
    }

    const number = document.getElementById('number')

    function getHash() {
      return location.hash.substr(1)
    }

    function getInterval() {
      var parts = getHash().indexOf(':') == -1 ? [] : getHash().split(':')
      return parts[0] || 3000
    }

    function getThings() {
      return (getHash() != '') ? getHash().split(':').at(-1).split('-') : [0, 1, 2, 3]
    }

    function getMode() {
      if (JSON.stringify(getThings()) == '["violin"]')
        return 'violin'
      else
        return 'regular'
    }

    function nextItem() {
      document.querySelector('.wrap').dataset.mode = getMode()

      if (getMode() == 'violin') {
        let [semi, name] = pick(randomViolinNote())
        number.innerHTML = name
        tone = semi
      } else
        number.innerHTML = randomItem(getThings())

      stop() // must come after `timeoutId = ...`

      timeoutId = setTimeout(nextItem, getInterval())
    }

    function button(event, key) {
      if (key == 's' || key == 'Escape') stop(event)
      if (key == 'ArrowLeft' || key == 'PageDown' || key == 'ArrowUp') { playTone(fromPianoToFreq(tone)) }
      if (key == 'ArrowRight' || key == 'PageUp' || key == 'ArrowDown' || key == 'Enter' || key == ' ') nextItem()
    }

    let tone
    let timeoutId

    setTimeout(nextItem, getInterval())

    addEventListener('hashchange', () => document.location.reload())
    addEventListener('keydown', (e) => button(event, e.key))
    addEventListener('DOMContentLoaded', nextItem)

    // TODO: show a diatonic interval as the base position
  </script>
</body>
</html>
