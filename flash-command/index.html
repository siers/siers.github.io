<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flash Command</title>
<style>
  :root { --bg: hsl(28 30% 13%); --fg: #efeae6; }

  html,body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  .stop { position: absolute; top: 1em; left: 1em; font-size: 3em; }
  .wrap { height: 100dvh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .number { font-weight: 700; font-size: 60vmin; display: inline-block; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); transition: transform 450ms ease; text-wrap: nowrap; }
  .wrap[data-mode=violin] .number { font-family: monospace; font-size: 60px; }
  ::selection { background: transparent; }
</style>
</head>
<body>
  <a class="stop" onclick="stop">stop</a>

  <div class="wrap">
    <div id="number" class="number">0</div>
  </div>

  <script>
    function randomViolinNote(string, pos, semi) {
      var [s_, f_, n_] = ['♯', '♭', '♮']

      var strings = [
        {name: 'G', number: 0},
        {name: 'D', number: 1},
        {name: 'A', number: 2},
        {name: 'E', number: 3},
      ]

      var positions = [
        {name: '1', count: 1, semi: 2},
        {name: '2', count: 2, semi: 4},
        {name: '3', count: 3, semi: 5},
        {name: '4', count: 4, semi: 7},
        {name: '5', count: 5, semi: 9},
      ]

      // TODO: make -1 a valid position semitone
      var positionSemitones = [-1, 0, 1, 2, 3, 4, 5, 6]

      function log(x) {
        console.log(x)
      }

      function randInt(from, to) {
        return from + Math.floor(Math.random() * (to - from + 1))
      }

      function pick(array) {
        return array[randInt(0, array.length - 1)]
      }

      // input: piano key number
      function nameNote(semi) {
        var und = undefined
        var notes = [
          {s: und, n: 'A', f: und},
          {s: 'A', n: und, f: 'B'},
          {s: und, n: 'B', f: 'C'},
          {s: 'B', n: 'C', f: und},
          {s: 'C', n: und, f: 'D'},
          {s: und, n: 'D', f: und},
          {s: 'D', n: und, f: 'E'},
          {s: und, n: 'E', f: und},
          {s: und, n: 'F', f: und},
          {s: 'F', n: und, f: 'G'},
          {s: und, n: 'G', f: und},
          {s: 'G', n: und, f: 'A'},
        ].map(n => {
          return {f: n.f && n.f + f_, n: n.n && n.n + n_, s: n.s && n.s + s_}
        })
        return notes[(12000 + semi - 49) % 12]
      }

      // TODO FIX: the random is slightly biased, because it's rand(position) + rand(semitone)
      function main(string, pos, semi) {
        string = string !== undefined ? string : pick(strings)
        pos = pos !== undefined ? pos : pick(positions)
        semi = semi !== undefined ? semi : pick(positionSemitones)
        var totalSemitone = 47 + string.number * 7 + pos.semi + semi
        var name = pick(Object.values(nameNote(totalSemitone)).filter(n => n))

        var fingers = {
          '-1': ['½'],
          '0': ['1'],
          '1': ['1', '2'],
          '2': ['2'],
          '3': ['3'],
          '4': ['3', '4'],
          '5': ['4'],
          '6': ['4'],
        }[semi]
        var finger = 1

        var rightPad = (s, n) => ('' + s).padEnd(n, ' ').replaceAll(' ', '&nbsp;')
        var fingerLabel = pick(fingers)
          .replace(/^(\d)$/, '$1.')
          .replace('½', '.½')

        var slide = pick('-↑↓'.split(''))
        var bowing = pick('VΠ'.split(''))
        var label = `${string.name}/${pos.name}p/${rightPad(name, 2)}/${fingerLabel}/${slide}/${bowing}`

        log(`semi = ${semi}, label = ${label}`)
        return [totalSemitone, label]
      }

      return main(
        string !== undefined ? strings[string] : undefined,
        pos !== undefined ? positions[pos] : undefined,
        semi,
      )
    }
  </script>

<script>
    function shiftBy(arr, n) {
      const len = arr.length;
      if (len === 0) return [];
      n = ((n % len) + len) % len; // normalize
      return arr.slice(-n).concat(arr.slice(0, len - n));
    }

    function droneFrequencyDecibels() {
      return [
        [110.357666,-31.528101],
        [220.042419,-28.646994],
        [440.084839,-24.412590],
        [660.473083,-38.638454],
        [880.169678,-28.603935],
        [1320.254517,-29.170403],
      ]
    }

    function baseFrequencyCoefs(baseFreq) {
      var coefs = droneFrequencyDecibels()
      var highestHz = Math.floor(Math.max(...coefs.map(x => x[0])))
      var real = new Float32Array(Array(highestHz).fill(0))
      var imag = new Float32Array(Array(highestHz).fill(0))

      coefs.forEach(a => real[Math.floor(Math.floor(a[0]) * (baseFreq / 440))] = Math.pow(10, a[1] / 20))

      return [new Float32Array(real), new Float32Array(imag)]
    }

    function createOscillatorBeefy(fundamental) {
      let osc = audioCtx.createOscillator()
      const wave = audioCtx.createPeriodicWave(...baseFrequencyCoefs(fundamental))

      osc.setPeriodicWave(wave)
      osc.frequency.value = 1

      return osc
    }

    function fromPianoToFreq(keyNr) {
      return 2 ** ((keyNr - 49) / 12) * 442
    }

    function playTone(tone) {
      if (osc) osc.stop(audioCtx.currentTime)

      osc = createOscillatorBeefy(tone)
      osc.connect(audioCtx.destination)
      osc.start()
    }

    function stop(event) {
      if (event) event.stopPropagation()
      if (osc) osc.stop()
      clearTimeout(timeoutId)
    }

    function button(event, key) {
      if (key == 's' || key == 'Escape') stop(event)
      if (key == 'ArrowLeft' || key == 'PageDown' || key == 'ArrowUp') nextTone(1)
      if (!osc || key == 'ArrowRight' || key == 'PageUp' || key == 'ArrowDown' || key == 'Enter' || key == ' ') nextTone(-1)
    }

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)()
    let tones = [] // see getTones()
    let osc
  </script>

  <script>
    function randomItem(array) {
      return array[Math.floor(Math.random() * array.length)]
    }

    const number = document.getElementById('number')

    function getHash() {
      return location.hash.substr(1)
    }

    function getInterval() {
      var parts = getHash().indexOf(':') == -1 ? [] : getHash().split(':')
      return parts[0] || 3000
    }

    function getThings() {
      return (getHash() != '') ? getHash().split(':').at(-1).split('-') : [0, 1, 2, 3]
    }

    function getMode() {
      if (JSON.stringify(getThings()) == '["violin"]')
        return 'violin'
      else
        return 'regular'
    }

    function nextItem() {
      document.querySelector('.wrap').dataset.mode = getMode()

      if (getMode() == 'violin') {
        let [semi, name] = randomViolinNote()
        number.innerHTML = name
        tone = semi
      } else
        number.innerHTML = randomItem(getThings())

      stop() // must come after `timeoutId = ...`

      timeoutId = setTimeout(nextItem, getInterval())
    }

    function button(event, key) {
      if (key == 's' || key == 'Escape') stop(event)
      if (key == 'ArrowLeft' || key == 'PageDown' || key == 'ArrowUp') { playTone(fromPianoToFreq(tone)) }
      if (key == 'ArrowRight' || key == 'PageUp' || key == 'ArrowDown' || key == 'Enter' || key == ' ') nextItem()
    }

    let tone
    let timeoutId

    setTimeout(nextItem, getInterval())

    addEventListener('hashchange', () => document.location.reload())
    addEventListener('keydown', (e) => button(event, e.key))
    addEventListener('DOMContentLoaded', nextItem)
  </script>
</body>
</html>
