<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drone app</title>
    <style>
      html { margin: 0; padding: 0; background: #222; font-size: 3em; color: white; user-select: none; }
      body { margin: 0; padding: 0; }
      .stop { position: absolute; top: 1em; left: 1em; }

      .wrap { height: 100dvh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .note { font-weight: 700; font-size: 60vmin; display: inline-block; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); transition: transform 450ms ease; }
    </style>
  </head>
  <body>
    <a class="stop" onclick="stop">stop</a>

    <div class="wrap">
      <div class="note"></div>
    </div>

    <script>
      let audioCtx = new (window.AudioContext || window.webkitAudioContext)()
      let tones = [] // see getTones()
      let osc

      function shiftBy(arr, n) {
        const len = arr.length;
        if (len === 0) return [];
        n = ((n % len) + len) % len; // normalize
        return arr.slice(-n).concat(arr.slice(0, len - n));
      }

      function droneFrequencyDecibels() {
        // 1. download https://www.youtube.com/watch?v=8P7O1iJYrlg
        // 2. copy over the audio over itself in audacity
        // 3. export spectrum with large bucket size
        // 4. grep -E "^[^	]+	-[1-3]\d\." spectrum.txt | sed 's/\t/,/; s/^/[/; s/$/],/' | pbcopy
        return [
          [109.684753,-27.196688],
          [110.357666,-21.528101],
          [111.030579,-28.663891],
          [220.042419,-28.646994],
          [220.715332,-28.540955],
          [438.739014,-27.267790],
          [440.084839,-24.412590],
          [440.757751,-29.347168],
          [441.430664,-29.811642],
          [879.496765,-29.765196],
          [880.169678,-28.603935],
        ]
      }

      function baseFrequencyCoefs(baseFreq) {
        var coefs = droneFrequencyDecibels()
        var highestHz = Math.floor(Math.max(...coefs.map(x => x[0])))
        var real = new Float32Array(Array(highestHz).fill(0))
        var imag = new Float32Array(Array(highestHz).fill(0))

        coefs.forEach(a => real[Math.floor(a[0] * (baseFreq / 440))] = Math.pow(10, a[1] / 20))

        return [new Float32Array(real), new Float32Array(imag)]
      }

      function createOscillatorBeefy(fundamental) {
        let osc = audioCtx.createOscillator()
        const wave = audioCtx.createPeriodicWave(...baseFrequencyCoefs(fundamental))

        osc.setPeriodicWave(wave)
        osc.frequency.value = 1

        return osc
      }

      function createOscillatorSimple(fundamental) {
        let osc = audioCtx.createOscillator()

        // Define harmonics (real = cos terms, imag = sin terms)
        // Index 0 unused, index n = nth harmonic
        const real = new Float32Array([0, 1, 0.25, 0.125]) // fundamental + 2f + 3f
        const imag = new Float32Array(real.length) // all 0 = no phase shift

        const wave = audioCtx.createPeriodicWave(real, imag)
        osc.setPeriodicWave(wave)

        osc.frequency.value = fundamental / 4

        return osc
      }

      function getHash() {
        return location.hash.substr(1) || 'C3-G3-D3-A3-E3-B3-Gb3-Db3-Ab3-Eb3-Bb3-F3'
      }

      function fromPianoToFreq(keyNr) {
        return 2 ** ((keyNr - 49) / 12) * 442
      }

      function getTones() {
        return getHash().split('-').map(t => {
          var letterDict = {A: 49, B: 51, C: 52, D: 54, E: 56, F: 57, G: 59}
          var accidentalDict = {b: -1, s: 1, i: 1, is: 1, es: -2, '': 0}

          var letter = t.match(/^[a-z]/i)[0].toUpperCase()
          var accidental = (t.match(/^[a-z](b|s|i|is|es)/i) || [])[1] || ''
          var number = (t.match(/\d+$/) || 4) - 4

          return [t, fromPianoToFreq(letterDict[letter] + 12 * number + accidentalDict[accidental])]
        })
      }

      function nextTone(by) {
        tones = shiftBy(tones, by)
        tone = tones[0]

        document.querySelector('.note').innerHTML = tone[0]

        if (osc) osc.stop(audioCtx.currentTime)

        // osc = createOscillatorBeefy(tone[1])
        osc = createOscillatorSimple(tone[1])
        osc.connect(audioCtx.destination)
        osc.start()
      }

      function stop(event) {
        // BUG: stop on a freshly opened app causes an exception
        event.stopPropagation()
        osc.stop()
      }

      function button(event, key) {
        if (key == 's' || key == 'Escape') stop(event)
        if (key == 'ArrowLeft' || key == 'PageDown' || key == 'ArrowUp') nextTone(1)
        if (!osc || key == 'ArrowRight' || key == 'PageUp' || key == 'ArrowDown' || key == 'Enter' || key == ' ') nextTone(-1)
      }

      tones = shiftBy(getTones(), 1)

      addEventListener('click', () => button(null, 'Enter'))
      addEventListener('keydown', (e) => button(event, e.key))

      document.querySelector('a.stop').addEventListener('click', stop)
    </script>
  </body>
</html>
